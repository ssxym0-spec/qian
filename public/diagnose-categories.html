<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ç±»è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #d97706;
            padding-bottom: 10px;
        }
        h2 {
            color: #666;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f8f8;
            font-weight: 600;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.ok {
            background: #d1fae5;
            color: #065f46;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .code {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre;
            overflow-x: auto;
            margin: 15px 0;
        }
        button {
            background: #d97706;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        button:hover {
            background: #b45309;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error-msg {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å“ç±»è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©ä½ è¯Šæ–­å“ç±»æ˜ å°„é—®é¢˜ï¼Œæ‰¾å‡ºå¯¼è‡´404é”™è¯¯çš„åŸå› </p>
        
        <button onclick="diagnose()">å¼€å§‹è¯Šæ–­</button>
        
        <div id="results"></div>
    </div>

    <script>
        // ğŸ¯ ç°åœ¨ slug ç”±åç«¯ç›´æ¥æä¾›ï¼Œæ— éœ€å‰ç«¯æ˜ å°„

        async function diagnose() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">æ­£åœ¨æ£€æŸ¥...</div>';
            
            try {
                // è·å–é¦–é¡µå“ç±»åˆ—è¡¨
                const landingResponse = await fetch('http://localhost:3000/api/public/landing-page');
                const landingData = await landingResponse.json();
                const landingCategories = landingData.categories || [];
                
                // è·å–æº¯æºé¡µå“ç±»åˆ—è¡¨ï¼ˆåŒ…å«slugï¼‰
                const categoriesResponse = await fetch('http://localhost:3000/api/public/categories');
                const categoriesData = await categoriesResponse.json();
                
                // åˆ›å»ºå“ç±»åç§°åˆ°slugçš„æ˜ å°„
                const categorySlugMap = new Map();
                categoriesData.forEach(cat => {
                    categorySlugMap.set(cat.name, cat.slug);
                });
                
                // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
                let html = '<h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>';
                
                // é¦–é¡µå“ç±»åˆ—è¡¨
                html += '<h3>é¦–é¡µå“ç±»åˆ—è¡¨ (landing-page API)</h3>';
                html += '<table><thead><tr><th>é¡ºåº</th><th>å“ç±»åç§°</th><th>Slug (åç«¯)</th><th>çŠ¶æ€</th><th>URL</th></tr></thead><tbody>';
                
                landingCategories.forEach((cat, index) => {
                    const slug = cat.slug || categorySlugMap.get(cat.name);
                    const hasSlug = !!slug;
                    const status = hasSlug 
                        ? '<span class="status ok">âœ“ æœ‰slug</span>' 
                        : '<span class="status error">âœ— æ— slug</span>';
                    
                    html += `<tr>
                        <td>${index}</td>
                        <td>${cat.name}</td>
                        <td><code>${slug || 'N/A'}</code></td>
                        <td>${status}</td>
                        <td><code>/suyuan/${slug || '???'}</code></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                
                // æº¯æºé¡µå“ç±»åˆ—è¡¨
                html += '<h3>æº¯æºé¡µå“ç±»åˆ—è¡¨ (categories API)</h3>';
                html += '<table><thead><tr><th>å“ç±»åç§°</th><th>Slug (åç«¯)</th><th>æ‰¹æ¬¡æ•°é‡</th><th>çŠ¶æ€</th></tr></thead><tbody>';
                
                categoriesData.forEach(cat => {
                    const hasSlug = !!cat.slug;
                    const status = hasSlug 
                        ? '<span class="status ok">âœ“ æœ‰slug</span>' 
                        : '<span class="status error">âœ— æ— slug</span>';
                    
                    html += `<tr>
                        <td>${cat.name}</td>
                        <td><code>${cat.slug || 'N/A'}</code></td>
                        <td>${cat.count}</td>
                        <td>${status}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                
                // æ£€æŸ¥ä¸ä¸€è‡´
                const landingNames = new Set(landingCategories.map(c => c.name));
                const categoriesNames = new Set(categoriesData.map(c => c.name));
                
                const onlyInLanding = [...landingNames].filter(n => !categoriesNames.has(n));
                const onlyInCategories = [...categoriesNames].filter(n => !landingNames.has(n));
                
                if (onlyInLanding.length > 0 || onlyInCategories.length > 0) {
                    html += '<h3>âš ï¸ æ•°æ®ä¸ä¸€è‡´è­¦å‘Š</h3>';
                    if (onlyInLanding.length > 0) {
                        html += `<div class="error-msg">ä»…åœ¨é¦–é¡µAPIä¸­å­˜åœ¨: ${onlyInLanding.join(', ')}</div>`;
                    }
                    if (onlyInCategories.length > 0) {
                        html += `<div class="error-msg">ä»…åœ¨å“ç±»APIä¸­å­˜åœ¨: ${onlyInCategories.join(', ')}</div>`;
                    }
                }
                
                // æ£€æŸ¥slugå®Œæ•´æ€§
                const missingSlugCategories = [];
                landingCategories.forEach(cat => {
                    const slug = cat.slug || categorySlugMap.get(cat.name);
                    if (!slug) {
                        missingSlugCategories.push(cat.name);
                    }
                });
                
                if (missingSlugCategories.length > 0) {
                    html += '<h3>âš ï¸ å‘ç°é—®é¢˜</h3>';
                    html += '<div class="error-msg">';
                    html += '<strong>ä»¥ä¸‹å“ç±»ç¼ºå°‘ slug å­—æ®µï¼š</strong><br><br>';
                    missingSlugCategories.forEach(name => {
                        html += `â€¢ ${name}<br>`;
                    });
                    html += '</div>';
                    html += '<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>';
                    html += '<p>è”ç³»åç«¯å¼€å‘äººå‘˜ï¼Œç¡®ä¿ <code>/api/public/categories</code> å’Œ <code>/api/public/landing-page</code> æ¥å£éƒ½è¿”å› slug å­—æ®µã€‚</p>';
                    html += '<p>å‚è€ƒæ–‡æ¡£ï¼š<code>CATEGORY_404_FIX_GUIDE.md</code></p>';
                } else {
                    html += '<div class="status ok" style="display: block; margin: 20px 0; padding: 20px; text-align: center; font-size: 18px;">';
                    html += 'âœ… æ‰€æœ‰å“ç±»éƒ½å·²æ­£ç¡®é…ç½®ï¼<br><br>';
                    html += 'åç«¯APIè¿”å›äº†å®Œæ•´çš„slugå­—æ®µï¼Œå‰ç«¯æ— éœ€ç»´æŠ¤æ˜ å°„è¡¨ã€‚';
                    html += '</div>';
                }
                
                // æµ‹è¯•URLå¯è®¿é—®æ€§
                html += '<h3>ğŸ”— æµ‹è¯•å“ç±»URLå¯è®¿é—®æ€§</h3>';
                html += '<table><thead><tr><th>å“ç±»</th><th>Slug</th><th>URL</th><th>çŠ¶æ€</th></tr></thead><tbody>';
                
                for (let i = 0; i < landingCategories.length; i++) {
                    const cat = landingCategories[i];
                    const slug = cat.slug || categorySlugMap.get(cat.name);
                    
                    if (!slug) {
                        html += `<tr>
                            <td>${cat.name}</td>
                            <td><span class="status error">æ— slug</span></td>
                            <td>-</td>
                            <td><span class="status error">æ— æ³•æµ‹è¯•</span></td>
                        </tr>`;
                        continue;
                    }
                    
                    const url = `http://localhost:3000/suyuan/${slug}`;
                    
                    try {
                        const response = await fetch(url);
                        const statusText = response.ok 
                            ? '<span class="status ok">âœ“ å¯è®¿é—®</span>' 
                            : `<span class="status warning">${response.status}</span>`;
                        
                        html += `<tr>
                            <td>${cat.name}</td>
                            <td><code>${slug}</code></td>
                            <td><a href="${url}" target="_blank">/suyuan/${slug}</a></td>
                            <td>${statusText}</td>
                        </tr>`;
                    } catch (error) {
                        html += `<tr>
                            <td>${cat.name}</td>
                            <td><code>${slug}</code></td>
                            <td>/suyuan/${slug}</td>
                            <td><span class="status error">âœ— é”™è¯¯</span></td>
                        </tr>`;
                    }
                }
                
                html += '</tbody></table>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-msg">
                    <strong>è¯Šæ–­å¤±è´¥ï¼š</strong>${error.message}<br><br>
                    è¯·ç¡®ä¿ï¼š<br>
                    1. å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (npm run dev)<br>
                    2. APIæ¥å£å¯ä»¥æ­£å¸¸è®¿é—®<br>
                    3. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤æ–‡ä»¶
                </div>`;
            }
        }
    </script>
</body>
</html>

