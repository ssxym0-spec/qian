# 批次详情页跳转生长日记功能说明

## 功能概述

在批次详情页的"鲜叶采集"时间轴中，每条采摘记录下方都有一个"查看当日生长记录"链接。点击该链接后，会自动跳转到生长日记页面，并自动选中对应日期的生长日记卡片（显示橙色呼吸边框效果），同时平滑滚动到该卡片位置。

## 实现原理

### 1. URL 参数传递

当用户点击"查看当日生长记录"时，会跳转到以下格式的URL：

```
/shengzhang?month=2025-03&date=25
```

**参数说明：**
- `month`: 年月格式（YYYY-MM），用于加载对应月份的数据
- `date`: 目标日期（日），用于自动定位并打开对应的卡片

### 2. 自动选中逻辑

生长日记页面接收到 `date` 参数后，会执行以下流程：

1. **加载数据和模板**：等待天气图标模板和页面数据加载完成
2. **传递参数到卡片流**：将 `targetDate` 参数传递给 `CardStream` 组件
3. **查找目标卡片**：在 `CardStream` 中查找匹配日期的卡片
4. **激活卡片状态**：调用 `setActiveCard` 设置卡片为激活状态（显示橙色呼吸边框）
5. **滚动到卡片**：延迟500ms后使用 `scrollIntoView` 平滑滚动到卡片位置

**日期匹配逻辑：**
- 如果 `date` 参数是纯数字（如 "25"），则匹配日期的"日"部分
- 如果 `date` 参数是完整日期（如 "2025-03-25"），则完整匹配日期字符串

**激活状态管理：**
- 使用 `useActiveCard` Hook 管理卡片激活状态
- 激活状态会保存到 localStorage，刷新页面后依然保持
- 橙色呼吸边框效果与手动点击卡片时完全一致

## 修改的文件

### 1. `app/suyuan/components/StoryTimeline.tsx`

**修改位置：** 第285-295行

**修改内容：** 更新 `getGrowthLink` 函数，确保传递完整的年月信息

```typescript
const getGrowthLink = (dateString: string) => {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = date.getDate();
  return `/shengzhang?month=${year}-${month}&date=${day}`;
};
```

### 2. `app/shengzhang/page.tsx`

**修改位置：** 第19-29行、第62-66行

**修改内容：**
- 在 `searchParams` 类型定义中添加 `date?: string`
- 从 URL 参数中提取 `targetDate`
- 将 `targetDate` 传递给 `GrowthPageClientWrapper` 组件

```typescript
export default async function ShengzhangPage({
  searchParams,
}: {
  searchParams: { month?: string; date?: string };
}) {
  const currentMonth = searchParams.month || /* ... */;
  const targetDate = searchParams.date;
  
  // ...
  
  return (
    <GrowthPageClientWrapper 
      initialData={data} 
      currentMonth={currentMonth}
      targetDate={targetDate}
    />
  );
}
```

### 3. `app/components/growth/GrowthPageClientWrapper.tsx`

**修改位置：** 第30-34行、第40-44行、第140-146行

**修改内容：**
- 在组件 Props 中添加 `targetDate?: string` 参数
- 将 `targetDate` 传递给 `CardStream` 组件
- 移除了之前自动打开详情面板的逻辑（现在改为只选中卡片）

```typescript
interface GrowthPageClientWrapperProps {
  initialData: GrowthData;
  currentMonth: string;
  targetDate?: string; // 目标日期，用于自动选中对应的卡片
}

export default function GrowthPageClientWrapper({
  initialData,
  currentMonth,
  targetDate,
}: GrowthPageClientWrapperProps) {
  // ...
  
  return (
    <CardStream
      dailyLogs={initialData.daily_logs || initialData.dailyLogs || []}
      monthlySummary={initialData.monthly_summary || initialData.monthlySummary || null}
      onOpenDaily={handleOpenDaily}
      onOpenMonthly={handleOpenMonthly}
      targetDate={targetDate}
    />
  );
}
```

### 4. `app/components/growth/CardStream.tsx` 🆕

**修改位置：** 第1-7行、第8-14行、第21-85行、第106-120行

**修改内容（核心逻辑）：**
- 导入 `useEffect` 和 `useRef` 用于管理 DOM 引用和副作用
- 在组件 Props 中添加 `targetDate?: string` 参数
- 添加 `cardRefs` 用于存储每个卡片的 DOM 引用
- 添加 `useEffect` 监听 `targetDate`，查找并选中对应卡片
- 在卡片渲染时添加 `ref` 引用，以便滚动定位

```typescript
import { useEffect, useRef } from 'react';

interface CardStreamProps {
  dailyLogs: DailyLog[];
  monthlySummary: MonthlySummary | null;
  onOpenDaily: (log: DailyLog) => void;
  onOpenMonthly: (summary: MonthlySummary) => void;
  targetDate?: string; // 🆕 目标日期，用于自动选中卡片
}

export default function CardStream({ /* ... */, targetDate }: CardStreamProps) {
  const { isCardActive, setActiveCard } = useActiveCard('daily-logs');
  const cardRefs = useRef<{ [key: string]: HTMLDivElement | null }>({});
  
  // 🆕 自动选中卡片逻辑
  useEffect(() => {
    if (!targetDate || sortedLogs.length === 0) {
      return;
    }

    // 查找匹配的日志记录
    const targetLogIndex = sortedLogs.findIndex(log => {
      const logDate = new Date(log.date);
      const logDay = logDate.getDate();
      
      if (/^\d+$/.test(targetDate)) {
        return logDay === parseInt(targetDate, 10);
      }
      
      return log.date === targetDate;
    });

    if (targetLogIndex !== -1) {
      const targetLog = sortedLogs[targetLogIndex];
      const cardId = `${targetLog.date}-${targetLogIndex}`;
      
      // 延迟设置激活状态和滚动
      setTimeout(() => {
        // 设置激活状态（显示橙色呼吸边框）
        setActiveCard(cardId);
        
        // 滚动到对应卡片
        const cardElement = cardRefs.current[cardId];
        if (cardElement) {
          cardElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
          });
        }
      }, 500);
    }
  }, [targetDate, sortedLogs, setActiveCard]);
  
  // 渲染卡片时添加 ref
  return (
    <div
      ref={(el) => { cardRefs.current[cardId] = el; }}
      className="animate-fadeIn"
    >
      <DailyLogCard /* ... */ />
    </div>
  );
}
```

## 测试步骤

### 测试场景 1：正常跳转并选中卡片

1. 访问任意批次详情页，例如：`/suyuan/batch/[batchId]`
2. 滚动到"鲜叶采集"时间轴部分
3. 找到任意一条采摘记录，点击底部的"查看当日生长记录"链接
4. **预期结果：**
   - 页面跳转到生长日记页面
   - 自动定位到对应的月份
   - 对应日期的卡片显示橙色呼吸边框效果（激活状态）
   - 页面平滑滚动到该卡片位置（卡片居中显示）
   - **不会**自动打开详情面板

### 测试场景 2：跨月份跳转

1. 如果批次有多天采摘记录，跨越不同月份
2. 点击不同月份的采摘记录的"查看当日生长记录"
3. **预期结果：**
   - 正确跳转到对应的月份
   - 自动选中对应日期的卡片并显示橙色呼吸边框
   - 平滑滚动到卡片位置

### 测试场景 3：无匹配记录

1. 人为修改URL参数，访问一个不存在的日期
2. 例如：`/shengzhang?month=2025-03&date=99`
3. **预期结果：**
   - 页面正常显示生长日记列表
   - 不会选中任何卡片
   - 控制台显示警告：`⚠️ [CardStream] 未找到目标日期的卡片: 99`

### 测试场景 4：手动点击卡片后的状态保持

1. 从批次详情页跳转到生长日记，卡片自动被选中
2. 点击该卡片打开详情面板
3. 关闭详情面板
4. **预期结果：**
   - 卡片依然保持激活状态（橙色呼吸边框）
   - 状态保存在 localStorage 中
   - 刷新页面后激活状态依然保持

### 测试场景 5：点击其他卡片

1. 从批次详情页跳转到生长日记，卡片A自动被选中
2. 手动点击另一个卡片B
3. **预期结果：**
   - 卡片A的激活状态被移除
   - 卡片B显示橙色呼吸边框（成为激活状态）
   - 只有一个卡片处于激活状态

## 用户体验优化

### 1. 延迟选中和滚动（500ms）

卡片选中和滚动延迟500ms执行，确保：
- 页面已完全渲染
- 天气图标已加载完成
- 卡片渲染动画已完成
- 避免闪烁或视觉跳动
- 滚动动画更流畅

### 2. 平滑滚动效果

使用 `scrollIntoView` 的 `smooth` 模式：
- `behavior: 'smooth'`：平滑滚动动画
- `block: 'center'`：目标卡片居中显示
- 视觉效果友好，不会突兀跳转

### 3. 控制台日志

开发者可通过控制台日志跟踪跳转过程：

```
🎯 [CardStream] 找到目标日期的卡片，自动选中: 2025-03-25-0
📍 [CardStream] 已滚动到卡片位置
```

### 4. 激活状态视觉反馈

- **橙色呼吸边框**：与手动点击时完全一致的视觉效果
- **持久化状态**：使用 localStorage 保存，刷新页面后依然保持
- **唯一激活**：同一时间只有一个卡片处于激活状态
- **即时反馈**：状态变化立即可见

### 5. 兼容性考虑

- 如果没有 `date` 参数，页面正常显示，不会自动选中任何卡片
- 支持数字格式（"25"）和完整日期格式（"2025-03-25"）
- 自动匹配逻辑确保灵活性
- 找不到匹配卡片时不会报错，只显示警告

## 技术亮点

1. **类型安全**：所有参数都有 TypeScript 类型定义
2. **错误处理**：未找到匹配记录时不会报错，只在控制台警告
3. **性能优化**：使用 `setTimeout` 延迟选中和滚动，避免阻塞渲染
4. **状态管理**：复用现有的 `useActiveCard` Hook，状态持久化到 localStorage
5. **DOM 引用管理**：使用 `useRef` 存储卡片 DOM 引用，支持精确滚动定位
6. **平滑滚动**：原生 `scrollIntoView` API，无需额外依赖
7. **向后兼容**：不影响现有功能，可选参数设计
8. **分离关注点**：跳转逻辑在 `CardStream` 中实现，职责清晰

## 注意事项

1. **后端数据依赖**：确保生长日记 API 返回的数据包含对应日期的记录
2. **日期格式**：采摘记录和生长日记的日期格式必须一致（YYYY-MM-DD）
3. **月份参数**：必须传递完整的 `month` 参数（YYYY-MM），否则可能加载错误月份的数据

## 未来扩展

可能的功能扩展：

1. ✅ ~~**滚动定位**~~：已实现，自动滚动到对应卡片位置
2. ✅ ~~**高亮效果**~~：已实现，使用橙色呼吸边框标识激活状态
3. **面包屑导航**：显示从批次详情返回的路径
4. **历史记录**：记录用户的浏览路径，支持返回到上一页
5. **动画增强**：卡片选中时添加额外的动画效果（如缩放、闪烁等）
6. **URL 同步**：将激活的卡片 ID 同步到 URL，支持直接通过 URL 访问特定卡片

---

**实现日期：** 2025年10月13日  
**版本：** v2.0（优化版）  
**状态：** ✅ 已完成并优化

## 更新日志

### v2.0 (2025-10-13)
- ✨ 改进交互方式：从"自动打开详情面板"改为"选中卡片并显示橙色呼吸边框"
- ✨ 新增平滑滚动：自动滚动到目标卡片位置，居中显示
- ✨ 新增 DOM 引用管理：使用 `useRef` 实现精确的滚动定位
- 🔧 重构实现位置：将核心逻辑从 `GrowthPageClientWrapper` 移至 `CardStream`
- 🎨 提升用户体验：延迟时间从 300ms 调整为 500ms，确保动画完整
- 📝 完善文档：新增多个测试场景和详细的技术说明

### v1.0 (2025-10-13)
- 🎉 初始实现：支持从批次详情页跳转到生长日记并自动打开详情面板

