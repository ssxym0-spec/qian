# 批次号重复显示问题修复总结

## 🎯 问题描述

批次追溯卡上的批次名字显示有重复：
- **错误显示**：`春茶 · 春茶 · 批次 CQ-20250407-1`
- **正确显示**：`春茶 · 批次 CQ-20250407-1`

## 🔍 问题根源

后端返回的 `batch_number` 字段已经包含了完整的显示文本（包括品类名称），例如：
```
batch_number: "春茶 · 批次 CQ-20250407-1"
category_name: "春茶"
```

而前端代码在显示时又添加了一次 `category_name`，导致重复：
```jsx
{batch.category_name} · {batch.batch_number}
// 结果：春茶 · 春茶 · 批次 CQ-20250407-1
```

## ✅ 修复方案

使用正则表达式从 `batch_number` 字段中提取真正的批次号（如 `CQ-20250407-1` 或 `MQ-20250319`），然后手动格式化显示。

### 正则表达式说明（已更新）

**当前版本**（2025年10月8日）：
```javascript
batch_number.replace(/^.*?([A-Z]{2}-\d{8}(?:-\d+)?).*$/, '$1')
```

这个正则表达式：
- 匹配格式：`两个大写字母-8位数字-可选序号`
  - `CQ-20250407-1`（带序号）
  - `MQ-20250319`（不带序号）
- 使用 `(?:-\d+)?` 使序号部分变为可选
- 从任意文本中提取批次号
- 适用于各种品类的批次号格式（MQ、YQ、CQ、XQ、QC等）

**旧版本**（存在问题）：
```javascript
batch_number.replace(/^.*?([A-Z]{2}-\d{8}-\d+).*$/, '$1')
```
- ❌ 要求序号必须存在，否则匹配失败返回原值
- ❌ 导致像 `MQ-20250319` 这样的批次号无法正确提取

## 📝 已修改的文件

### 1. BatchCard.tsx（批次卡片组件）

**位置**：`app/suyuan/components/BatchCard.tsx` 第107行

**修改前**：
```jsx
{batch.category_name} · {batch.batch_number}
```

**修改后**（2025年10月8日更新）：
```jsx
{batch.category_name} · 批次 {batch.batch_number.replace(/^.*?([A-Z]{2}-\d{8}(?:-\d+)?).*$/, '$1')}
```

**显示效果**：
- `春茶 · 批次 CQ-20250407-1`（带序号）
- `明前茶 · 批次 MQ-20250319`（不带序号）

---

### 2. BatchDetailHeader.tsx（批次详情头部组件）

**位置**：`app/suyuan/components/BatchDetailHeader.tsx` 第151行和第154行

**修改前**：
```jsx
<h1>{title || batchNumber}</h1>
<p>{batchNumber}</p>
```

**修改后**（2025年10月8日更新）：
```jsx
<h1>{title || batchNumber.replace(/^.*?([A-Z]{2}-\d{8}(?:-\d+)?).*$/, '批次 $1')}</h1>
<p>批次 {batchNumber.replace(/^.*?([A-Z]{2}-\d{8}(?:-\d+)?).*$/, '$1')}</p>
```

**显示效果**：
- 标题：使用 `title`（如果有），否则显示 `批次 CQ-20250407-1`
- 副标题：`批次 CQ-20250407-1`

## 🎨 显示对比

### 批次列表卡片
```
❌ 问题显示：明前茶·批次 明前茶·批次 MQ-20250319
✅ 正确显示：明前茶 · 批次 MQ-20250319

❌ 问题显示：春茶 · 春茶 · 批次 CQ-20250407-1
✅ 正确显示：春茶 · 批次 CQ-20250407-1
```

### 批次详情页标题
```
修复前：春茶 · 批次 CQ-20250407-1（如果有 title）
         春茶 · 批次 CQ-20250407-1（如果没有 title）

修复后：年度至臻 静候春雷（如果有 title）✓
         批次 CQ-20250407-1（如果没有 title）✓

副标题：批次 CQ-20250407-1 ✓
```

### 顶部导航栏
```
已正确：春茶 CQ-20250407-1 ✓
```
（`BatchDetailTopNav` 组件之前已经正确使用了正则表达式提取）

## 🧪 验证步骤

1. **启动开发服务器**：
   ```bash
   npm run dev
   ```

2. **访问批次列表页**：
   - 访问任意品类，如 `http://localhost:3000/suyuan/chuncha`
   - 检查批次卡片标题显示为：`春茶 · 批次 CQ-20250407-1`

3. **访问批次详情页**：
   - 点击任意批次卡片
   - 检查页面标题和副标题显示正确
   - 检查顶部导航栏显示为：`春茶 CQ-20250407-1`

4. **测试所有品类**：
   - 明前茶（MQ）
   - 雨前茶（YQ）
   - 春茶（CQ）
   - 夏茶（XQ）
   - 秋茶（QC）

## 📊 影响范围

- ✅ 批次列表页的所有批次卡片
- ✅ 批次详情页的标题区域
- ✅ 确保与顶部导航栏的显示格式一致

## 🔧 技术细节

### 为什么使用正则表达式？

1. **灵活性**：可以从各种格式的字符串中提取批次号
2. **一致性**：所有组件使用相同的提取逻辑
3. **健壮性**：即使后端数据格式变化，正则表达式也能正确匹配

### 批次号格式说明

标准批次号格式：`[品类代码]-[日期YYYYMMDD]-[序号]`（序号可选）

支持的格式：
- **带序号**：`MQ-20250328-01` - 明前茶，2025年3月28日，第1批
- **带序号**：`CQ-20250407-1` - 春茶，2025年4月7日，第1批
- **不带序号**：`MQ-20250319` - 明前茶，2025年3月19日
- **不带序号**：`QC-20251003` - 秋茶，2025年10月3日

## ✨ 修复完成

现在所有批次名称都会正确显示，不再出现重复的品类名称！

---

## 📅 修复历史

### 第二次修复（2025年10月8日）
- **问题**：批次号格式 `MQ-20250319`（不带序号）无法被正则表达式匹配，导致重复显示
- **原因**：正则表达式要求序号必须存在 `-\d+`
- **修复**：将序号部分改为可选 `(?:-\d+)?`
- **影响文件**：
  - `app/suyuan/components/BatchCard.tsx` 第154行
  - `app/suyuan/components/BatchDetailHeader.tsx` 第174、177行

### 第一次修复（2025年10月6日）
- **问题**：批次标题显示重复，如 `春茶 · 春茶 · 批次 CQ-20250407-1`
- **修复**：使用正则表达式提取批次号，避免品类名称重复显示
- **影响文件**：2个组件文件（BatchCard.tsx、BatchDetailHeader.tsx）

