# ç”Ÿé•¿æ—¥å¿—é‡‡æ‘˜æ ‡ç­¾ - åç«¯å®ç°æŒ‡å—

## ğŸ“‹ å½“å‰çŠ¶æ€

âœ… **å‰ç«¯å·²å®Œæˆ**ï¼šå¡ç‰‡æ ‡ç­¾å’Œè¯¦æƒ…é¢æ¿æ¨¡å—å·²å®ç°  
âŒ **åç«¯å¾…å®ç°**ï¼šAPI æœªè¿”å›é‡‡æ‘˜æ•°æ®ï¼ˆæ‰€æœ‰é‡‡æ‘˜å­—æ®µä¸º `undefined`ï¼‰

---

## ğŸ”§ åç«¯éœ€è¦å®ç°çš„åŠŸèƒ½

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

åœ¨è·å–ç”Ÿé•¿æ—¥å¿—æ•°æ®æ—¶ï¼Œéœ€è¦å…³è”æŸ¥è¯¢å½“å¤©çš„é‡‡æ‘˜è®°å½•ã€‚

#### ä¼ªä»£ç ç¤ºä¾‹ï¼ˆNode.js/MongoDBï¼‰

```javascript
// åœ¨ /api/public/growth-data è·¯ç”±å¤„ç†å‡½æ•°ä¸­

async function getGrowthData(month) {
  // 1. æŸ¥è¯¢å½“æœˆçš„æ‰€æœ‰ç”Ÿé•¿æ—¥å¿—
  const logs = await GrowthLog.find({
    date: { $gte: startOfMonth, $lte: endOfMonth }
  });
  
  // 2. ä¸ºæ¯æ¡æ—¥å¿—æ·»åŠ é‡‡æ‘˜ä¿¡æ¯
  const logsWithHarvest = await Promise.all(logs.map(async (log) => {
    // æŸ¥è¯¢å½“å¤©çš„æ‰€æœ‰é‡‡æ‘˜è®°å½•
    const harvestRecords = await HarvestRecord.find({
      date: {
        $gte: new Date(log.date.setHours(0, 0, 0, 0)),
        $lt: new Date(log.date.setHours(23, 59, 59, 999))
      }
    }).populate('team.members'); // å¡«å……å›¢é˜Ÿæˆå‘˜ä¿¡æ¯
    
    // å¦‚æœæœ‰é‡‡æ‘˜è®°å½•ï¼Œè®¡ç®—ç»Ÿè®¡æ•°æ®
    if (harvestRecords.length > 0) {
      const totalWeight = harvestRecords.reduce((sum, r) => sum + r.weight_kg, 0);
      const firstRecord = harvestRecords[0];
      const leader = firstRecord.team?.members?.[0];
      
      return {
        ...log.toObject(),
        // ğŸ†• æ·»åŠ é‡‡æ‘˜å­—æ®µ
        has_harvest: true,
        harvest_count: harvestRecords.length,
        harvest_total_weight: totalWeight,
        harvest_leader_name: leader?.name || 'æœªçŸ¥',
        harvest_leader_avatar: leader?.avatar_url || null,
        harvest_team_count: firstRecord.team?.members?.length || 0,
        harvest_records: harvestRecords.map(r => ({
          id: r._id,
          weight: r.weight_kg,
          leader_name: r.team?.members?.[0]?.name || 'æœªçŸ¥',
          member_count: r.team?.members?.length || 0,
          leader_avatar: r.team?.members?.[0]?.avatar_url || null,
          assigned_batch_id: r.assigned_batch_id || null
        }))
      };
    }
    
    // æ— é‡‡æ‘˜è®°å½•
    return {
      ...log.toObject(),
      has_harvest: false,
      harvest_count: 0,
      harvest_total_weight: 0,
      harvest_leader_name: null,
      harvest_leader_avatar: null,
      harvest_team_count: 0,
      harvest_records: []
    };
  }));
  
  return {
    daily_logs: logsWithHarvest,
    monthly_summary: /* ... */
  };
}
```

---

### 2. è¿”å›æ•°æ®æ ¼å¼

#### å®Œæ•´çš„æ—¥å¿—å¯¹è±¡ç¤ºä¾‹

```json
{
  "date": "2025-03-19T00:00:00.000Z",
  "summary": "é˜´é›¨ç»µç»µï¼ŒèŒ¶èŠ½èŒåŠ¨æ˜æ˜¾...",
  "plot_name": "å°åœ°ä¸‰å·",
  "recorder": "å´å¸ˆå‚…",
  
  // ğŸ†• é‡‡æ‘˜ç›¸å…³å­—æ®µ
  "has_harvest": true,
  "harvest_count": 2,
  "harvest_total_weight": 50.5,
  "harvest_leader_name": "å¼ ä¸‰",
  "harvest_leader_avatar": "/uploads/avatars/zhangsan.jpg",
  "harvest_team_count": 8,
  "harvest_records": [
    {
      "id": "507f1f77bcf86cd799439011",
      "weight": 30.5,
      "leader_name": "å¼ ä¸‰",
      "member_count": 8,
      "leader_avatar": "/uploads/avatars/zhangsan.jpg",
      "assigned_batch_id": null
    },
    {
      "id": "507f1f77bcf86cd799439012",
      "weight": 20.0,
      "leader_name": "æå››",
      "member_count": 5,
      "leader_avatar": "/uploads/avatars/lisi.jpg",
      "assigned_batch_id": "507f1f77bcf86cd799439099"
    }
  ]
}
```

---

### 3. æ•°æ®åº“æ¨¡å‹è¦æ±‚

#### HarvestRecordï¼ˆé‡‡æ‘˜è®°å½•ï¼‰æ¨¡å‹

```javascript
const HarvestRecordSchema = new mongoose.Schema({
  date: { type: Date, required: true, index: true },
  weight_kg: { type: Number, required: true },
  team: {
    members: [{
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    }]
  },
  assigned_batch_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Batch',
    default: null
  },
  // å…¶ä»–å­—æ®µ...
});
```

#### Userï¼ˆç”¨æˆ·ï¼‰æ¨¡å‹

```javascript
const UserSchema = new mongoose.Schema({
  name: { type: String, required: true },
  avatar_url: { type: String, default: null },
  // å…¶ä»–å­—æ®µ...
});
```

---

## ğŸ§ª æµ‹è¯•æ•°æ®å‡†å¤‡

### æ–¹æ³•1ï¼šåœ¨æ•°æ®åº“ä¸­æ’å…¥æµ‹è¯•é‡‡æ‘˜è®°å½•

```javascript
// ç¤ºä¾‹ï¼šæ’å…¥æµ‹è¯•æ•°æ®
const testHarvestRecords = [
  {
    date: new Date('2025-03-19'),
    weight_kg: 30.5,
    team: {
      members: [userId1, userId2, userId3] // 8äººå›¢é˜Ÿ
    },
    assigned_batch_id: null
  },
  {
    date: new Date('2025-03-20'),
    weight_kg: 45.0,
    team: {
      members: [userId4, userId5]
    },
    assigned_batch_id: batchId1
  }
];

await HarvestRecord.insertMany(testHarvestRecords);
```

### æ–¹æ³•2ï¼šä½¿ç”¨ MongoDB Compass æ‰‹åŠ¨æ·»åŠ 

1. æ‰“å¼€ MongoDB Compass
2. è¿æ¥åˆ°æ•°æ®åº“
3. æ‰¾åˆ° `harvest_records` é›†åˆ
4. ç‚¹å‡» "INSERT DOCUMENT"
5. ç²˜è´´ä»¥ä¸‹ JSONï¼š

```json
{
  "date": { "$date": "2025-03-19T00:00:00.000Z" },
  "weight_kg": 30.5,
  "team": {
    "members": [
      { "$oid": "ä½ çš„ç”¨æˆ·ObjectId" }
    ]
  },
  "assigned_batch_id": null
}
```

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æµ‹è¯• API è¿”å›

```bash
# è®¿é—® API
curl http://localhost:3000/api/public/growth-data?month=2025-03 | json_pp
```

### 2. æ£€æŸ¥è¿”å›æ•°æ®

ç¡®è®¤ `daily_logs` ä¸­åŒ…å«é‡‡æ‘˜å­—æ®µï¼š
```json
{
  "daily_logs": [
    {
      "date": "2025-03-19T00:00:00.000Z",
      "has_harvest": true,  // âœ… å¿…é¡»å­˜åœ¨
      "harvest_count": 2,
      "harvest_total_weight": 50.5,
      "harvest_leader_name": "å¼ ä¸‰",
      // ...
    }
  ]
}
```

### 3. å‰ç«¯æµ‹è¯•

1. åˆ·æ–°ç”Ÿé•¿æ—¥è®°é¡µé¢
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. åº”è¯¥èƒ½çœ‹åˆ°ï¼š
   - âœ… å¡ç‰‡å·¦ä¸Šè§’æ˜¾ç¤ºæ©™è‰²"å·²é‡‡æ‘˜"æ ‡ç­¾
   - âœ… ç‚¹å‡»å¡ç‰‡åè¯¦æƒ…é¢æ¿æ˜¾ç¤º"ä»Šæ—¥é‡‡æ‘˜"æ¨¡å—

---

## ğŸ” è°ƒè¯•æŠ€å·§

### åç«¯è°ƒè¯•æ—¥å¿—

åœ¨è¿”å›æ•°æ®å‰æ·»åŠ æ—¥å¿—ï¼š

```javascript
console.log('ğŸ“Š é‡‡æ‘˜æ•°æ®ç»Ÿè®¡:', {
  æ—¥æœŸ: log.date,
  é‡‡æ‘˜è®°å½•æ•°: harvestRecords.length,
  æ€»é‡é‡: totalWeight,
  é˜Ÿé•¿: leader?.name
});
```

### å‰ç«¯è°ƒè¯•ï¼ˆä¸´æ—¶ï¼‰

å¦‚æœæƒ³åœ¨å‰ç«¯å…ˆæµ‹è¯• UIï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹æ•°æ®ï¼š

```typescript
// åœ¨ app/shengzhang/page.tsx ä¸­
const data = await response.json();

// ğŸ§ª ä¸´æ—¶æµ‹è¯•ï¼šä¸ºç¬¬ä¸€æ¡æ—¥å¿—æ·»åŠ é‡‡æ‘˜æ•°æ®
if (data.daily_logs && data.daily_logs.length > 0) {
  data.daily_logs[0].has_harvest = true;
  data.daily_logs[0].harvest_count = 2;
  data.daily_logs[0].harvest_total_weight = 50.5;
  data.daily_logs[0].harvest_leader_name = "å¼ ä¸‰";
  data.daily_logs[0].harvest_leader_avatar = "/uploads/test-avatar.jpg";
  data.daily_logs[0].harvest_team_count = 8;
}
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: é‡‡æ‘˜è®°å½•å’Œç”Ÿé•¿æ—¥å¿—çš„å…³ç³»ï¼Ÿ
A: ä¸€å¯¹å¤šå…³ç³»ã€‚ä¸€å¤©å¯ä»¥æœ‰å¤šæ¡é‡‡æ‘˜è®°å½•ï¼Œä½†åªæœ‰ä¸€æ¡ç”Ÿé•¿æ—¥å¿—ã€‚é‡‡æ‘˜æ•°æ®æ˜¯å½“å¤©æ‰€æœ‰é‡‡æ‘˜è®°å½•çš„æ±‡æ€»ã€‚

### Q2: å¦‚æœä¸€å¤©æœ‰å¤šä¸ªé‡‡æ‘˜é˜Ÿé•¿æ€ä¹ˆåŠï¼Ÿ
A: æ˜¾ç¤ºç¬¬ä¸€æ¡é‡‡æ‘˜è®°å½•çš„é˜Ÿé•¿ä¿¡æ¯ã€‚å¦‚æœéœ€è¦æ˜¾ç¤ºæ‰€æœ‰é˜Ÿé•¿ï¼Œå¯ä»¥å°† `harvest_records` æ•°ç»„ä¼ ç»™å‰ç«¯ã€‚

### Q3: å·²å½’å±å’Œæœªå½’å±çš„é‡‡æ‘˜è®°å½•å¦‚ä½•åŒºåˆ†ï¼Ÿ
A: é€šè¿‡ `assigned_batch_id` å­—æ®µï¼š
- `null`ï¼šæœªå½’å±
- æœ‰å€¼ï¼šå·²å½’å±åˆ°æŸä¸ªæ‰¹æ¬¡

### Q4: æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼Ÿ
A: 
1. ä¸º `HarvestRecord.date` æ·»åŠ ç´¢å¼•
2. ä½¿ç”¨ `populate` ä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®
3. è€ƒè™‘æ·»åŠ ç¼“å­˜ï¼ˆRedisï¼‰

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### å¿…é¡»å®ç°ï¼ˆP0ï¼‰
- âœ… æŸ¥è¯¢å½“å¤©é‡‡æ‘˜è®°å½•
- âœ… è®¡ç®— `has_harvest`, `harvest_count`, `harvest_total_weight`
- âœ… è·å–ç¬¬ä¸€ä¸ªé˜Ÿé•¿çš„å§“å

### å»ºè®®å®ç°ï¼ˆP1ï¼‰
- âœ… è·å–é˜Ÿé•¿å¤´åƒ `harvest_leader_avatar`
- âœ… è·å–å›¢é˜Ÿäººæ•° `harvest_team_count`

### å¯é€‰å®ç°ï¼ˆP2ï¼‰
- âšª å®Œæ•´çš„ `harvest_records` æ•°ç»„ï¼ˆå‰ç«¯æš‚æœªä½¿ç”¨ï¼‰

---

**å®ç°å®Œæˆåï¼Œå‰ç«¯å°†è‡ªåŠ¨æ˜¾ç¤ºé‡‡æ‘˜æ ‡ç­¾å’Œè¯¦æƒ…ï¼** ğŸ‰

---

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸï¼š** 2025å¹´10æœˆ13æ—¥  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** v1.0  
**çŠ¶æ€ï¼š** ğŸ“ å¾…åç«¯å®ç°

